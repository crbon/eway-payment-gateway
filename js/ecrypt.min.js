// eWAY Payment Gateway
// https://shop.webaware.com.au/downloads/eway-payment-gateway/

"use strict";!function(e){var a=eway_ecrypt_vars.fields,r=e(eway_ecrypt_vars.form);var t="function"==typeof String.prototype.repeat?function(e,a){return e.repeat(a)}:function(e,a){for(var r=e,t=1;t<a;t++)r+=e;return r};function n(a,n){var c=r.find(a);if(c.length){var o=c.val().replace(/[\s-]/g,""),i=o.length;if(i){if(n.is_cardnum&&!function(e){for(var a=0,r=1,t=e.length-1;t>=0;t--){var n=e.charAt(t)*r;r=1===r?2:1,n>=10&&(a++,n-=10),a+=n}return a%10==0}(o))throw{name:"Credit Card Error",message:eway_ecrypt_msg.card_number_invalid,field:c};var s=eCrypt.encryptValue(o,eway_ecrypt_vars.key),u=function(e,a,r){if(r){var n=t(e,4);return n+" "+n+" "+n+" "+n}return t(e,a)}(eway_ecrypt_msg.ecrypt_mask,i,n.is_cardnum);r.find("input[name='"+n.name+"']").remove(),e("<input type='hidden'>").attr("name",n.name).val(s).appendTo(r),n.false_fill?c.val(u):c.val("").data("eway-old-placeholder",c.prop("placeholder")).prop("placeholder",u)}}}function c(e){try{Object.keys(a).forEach(function(e){n(e,a[e])})}catch(a){return e.preventDefault(),a.field.focus(),window.alert(a.message),!1}return!0}function o(e){var a=!!r.length&&r.get(0).elements[e];return!!a&&a.value}function i(){Object.keys(a).forEach(function(e){var t=r.find(e);t.length&&(a[e].false_fill?t.val(""):t.prop("placeholder",t.data("eway-old-placeholder")))})}function s(e){"eway"===o("gateway")&&c(e)}function u(a,t,n){-1!==n.data.indexOf("em_checkout_page_contents")&&(r=e(eway_ecrypt_vars.form),i(),r.on("submit",s))}function f(){r=e(eway_ecrypt_vars.form),Object.keys(a).forEach(function(r){var t=e(r);if(t.length>0&&t.val().substring(0,1)!==eway_ecrypt_msg.ecrypt_mask)try{n(r,a[r])}catch(e){SPCO.form_is_valid=!1,event.preventDefault(),e.field.focus(),window.alert(e.message)}})}switch(eway_ecrypt_vars.mode){case"woocommerce":r.on("checkout_place_order_eway_payments",c),e(document.body).on("checkout_error",i);break;case"wp-e-commerce":r.on("submit",function(e){"wpsc_merchant_eway"===o("custom_gateway")&&c(e)});break;case"events-manager":r.on("submit",s),e(document).on("em_checkout_page_refresh",function(){e(document).ajaxComplete(u)});break;case"event-espresso":e(document).ready(function(){SPCO.main_container.on("process_next_step_button_click",f)});break;case"awpcp":r.on("submit",c)}}(jQuery);